<html>
    <head>
        <link rel="stylesheet" href="styles.css">
    </head>
    <body>
        <div id="wrapper">
            <!-- headers -->
            <h1>WebSockets Echo Demo</h1>
            <button type="submit" id="open_ws">Open WS</button>
            <div id="status">Status: Not connected</div>
            <div id="server_response"></div>
            <!-- message table -->
            <ul id="table"></ul>
            <!-- form -->
            <form id="form">
                <textarea id="message" placeholder="Write your message here..." required></textarea>
                <button type="submit">Send Message</button>
                <button id="close_ws">Close Connection</button>
                <button type="button" id="populate">Prepopulate</button>
            </form>
        </div>
        <script>
            // *** DOM ELEMENTS ***
            // buttons
            let open_ws_btn = document.getElementById("open_ws");
            let close_ws_btn = document.getElementById("close_ws")
            //form
            let form = document.getElementById("form");
            // other message related items
            let serverResponse = document.getElementById("server_response");
            let socketStatus = document.getElementById("status");
            let table = document.getElementsByTagName("ul")[0];
            let message = document.getElementById("message");
            let Populate = document.getElementById("populate");

            // *** WEBSOCKET SERVER ***
            open_ws_btn.addEventListener("click", () => {
                
                
                // BUTTON styling. when button is clicked, diable its use. 
                open_ws_btn.disabled = true; 
                open_ws_btn.style.background = 'gray';
                open_ws_btn.style.pointerEvents = 'none';
                open_ws_btn.textContent = "Button disabled";
                
                // TEXT: change the status message when the user starts opening a WS connection
                socketStatus.innerHTML = "Connecting ..."
                
                // #1 define websocket server location
                let url = "wss://localhost:4430";
                // #2. open up websocket server, using the client-side WebSocket API
                let socket = new WebSocket(url);

                // ## EVENT 1 of 4. 
                // OPEN EVENT
                socket.onopen = (openEvent) => {
                    // check its readyState property, it should be in connected state inside here as the 'open' event has been fired
                    console.log("SOCKET CONNECTING STATUS IS: " + socket.readyState);
                    // reset table values
                    table.innerHTML = "";
                    serverResponse.innerHTML = "";
                    // provide client-side feedback
                    console.log("SOCKET CONNECTING STATUS IS: " + socket.readyState);
                    socketStatus.innerHTML = `Connected to: ${openEvent.currentTarget.url}`;
                    socketStatus.className = "open";
                    // show the form
                    form.className = "show"; // you can also use the classList API

                    Populate.addEventListener("click", () => {
                        // prepopulate the message textarea with a medium-sized message
                        const text = "A".repeat(150000);
                        // const text = "A".repeat(10000) + "B".repeat(10000) + "C".repeat(10000) + "D".repeat(10000) + "E".repeat(10000);
                        // const text = "A".repeat(10000) + "B".repeat(10000) + "C".repeat(10000) + "D".repeat(10000) + "E".repeat(10000);
                        message.value = text;
                    });
                }

                // ## EVENT 2 of 4. 
                // MESSAGE EVENT: handle messages when they are received from server
                socket.onmessage = function(messageEvent) {
                    console.log(socket);
                    console.log(messageEvent);

                    if (messageEvent.data instanceof Blob) {
                        // if the message is a Blob, convert it to text
                        let reader = new FileReader();
                        reader.onload = function() {
                            // update our table with the received message
                            table.innerHTML += '<li class="received"><span>RECEIVED:</span>' + reader.result + '</li>';
                        message.placeholder = `(Previous message size: ${messageEvent.data.size} bytes)`;
                        };
                        reader.readAsText(messageEvent.data);

                    } else {
                        // if the message is a string, update our table directly
                        table.innerHTML += '<li class="received"><span>RECEIVED:</span>' + messageEvent.data + '</li>' ;
                    }
                };

                // ## EVENT 3 of 4. 
                // CLOSE EVENT
                socket.onclose = (closeEventObject) => {
                    console.log("CLOSE EVENT FIRED. CLOSE OBJECT", closeEventObject);
                    // let's style our closure text consistently across all scenarios
                    socketStatus.className = "closed";
                    table.innerHTML = "";
                    // using JavaScript's switch statement 
                    switch (closeEventObject.code) {
                        case 1001: // if a peer (client or server) closes the connection immediately
                            socketStatus.innerHTML = `Disconnected reason: ${closeEventObject.reason}`;
                            table.innerHTML = "";
                            break;
                        case 1002: // if the server closes the connection because of a protocol error
                            socketStatus.innerHTML = "Disconnected reason: ${closeEventObject.reason}";
                            table.innerHTML = "";
                            break;
                        case 1003: // if the server closes the connection because of a protocol error
                            socketStatus.innerHTML = "Unsupported data type received. Please check your message format.";
                            table.innerHTML = "";
                            break;
                        case 1006: // network problem (e.g. your websocket server is not running)
                            socketStatus.innerHTML = "Something is wrong with your WS newtork connection";
                            break;
                        case 1008: // network problem (e.g. your websocket server is not running)
                            socketStatus.innerHTML = "No status code provided. Please set a status code next time.";
                            serverResponse.innerHTML = `The server responded: ${closeEventObject.reason}`;   
                            break;
                        case 1009: // network problem (e.g. your websocket server is not running)
                            socketStatus.innerHTML = "Data too large. Please reduce the size of your message.";
                            serverResponse.innerHTML = `The server responded: ${closeEventObject.reason}`;   
                            break;
                        default: // when the client hits the close websocket button
                            socketStatus.innerHTML = `You disconnected by clicking the Close button.`;
                            serverResponse.innerHTML = `The server responded: ${closeEventObject.reason}`;   
                            break;
                        }

                    // CSS: FORM REMOVAL
                    form.classList.remove("show");
                    message.setAttribute("required", "true");
                    // CSS: BUTTON styling. When button is clicked, diable its use. 
                    open_ws_btn.disabled = false; 
                    open_ws_btn.style.background = '';
                    open_ws_btn.style.pointerEvents = '';
                    open_ws_btn.textContent = "Open WS";
                };

                // ## EVENT 4 of 4. 
                // ERROR EVENT
                socket.onerror = (error) => {
                    console.log("Error event was thrown. ERROR OBJECT: ", error);
                    socketStatus.innerHTML = "Error.";
                    socketStatus.className = "closed";
                }

                // ## METHOD 1 of 2. 
                // *** SEND METHOD
                form.addEventListener('submit', (e) => {
                    // stop default browswer refresh
                    e.preventDefault();

                    // implement extra safety measure by checking readyState before sending WS data
                    if(socket.readyState === 1) {
                        let user_text = message.value; 
                        socket.send(user_text); // use the send() method given to us by the WebSocket API
                        // update our table
                        table.innerHTML += '<li class="sent"><span>SENT:</span>' + user_text + '</li>';
                        message.value = "";
                    };
                });

                // ## METHOD 2 of 2. 
                // *** CLOSE METHOD
                close_ws_btn.addEventListener("click", () => {
                    socketStatus.innerHTML = "closing ... please wait ..."
                    socketStatus.classList.add('closing');
                    // close the websocket connection
                    socket.close(); // use the close() method on WebSocket API to send a closure code and reason to the server and close the WS connection
                    // styling
                    message.removeAttribute("required");
                    form.classList.remove("show");
                });
            });
        </script>
    </body>
</html>
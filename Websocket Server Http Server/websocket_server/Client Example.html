<html>
    <head>
        <link rel="stylesheet" href="styles.css">
    </head>
    <body>
        <div id="wrapper">
            <h1>WebSockets Echo Demo</h1>
            <button type="submit" id="open_ws">Open WS</button>
            <div id="status">Status: Not connected</div>
            <ul id="table"></ul>
            <form id="form">
                <textarea id="message" placeholder="Write your message here..." required></textarea>
                <button type="submit">Send Message</button>
                <button id="close_ws">Close Connection</button>
            </form>
        </div>
        <script>
            // *** DOM ELEMENTS ***
            let open_ws_btn = document.getElementById("open_ws");
            let close_ws_btn = document.getElementById("close_ws")
            let form = document.getElementById("form");
            let socketStatus = document.getElementById("status");
            let table = document.getElementsByTagName("ul")[0];
            let message = document.getElementById("message");

            // *** WEBSOCKET SERVER ***
            open_ws_btn.addEventListener("click", () => {
                
                
                open_ws_btn.disabled = true; 
                open_ws_btn.style.background = 'gray';
                open_ws_btn.style.pointerEvents = 'none';
                open_ws_btn.textContent = "Button disabled";
                
                socketStatus.innerHTML = "Connecting ..."
                
                let url = "ws://127.0.0.1:8080";
                let socket = new WebSocket(url);
                
                // OPEN EVENT
                socket.onopen = (openEvent) => {
                    console.log("SOCKET CONNECTING STATUS IS: " + socket.readyState);
                    table.innerHTML = "";
                    console.log("SOCKET CONNECTING STATUS IS: " + socket.readyState);
                    socketStatus.innerHTML = `Connected to: ${openEvent.currentTarget.url}`;
                    socketStatus.className = "open";
                    form.className = "show";
                }

                // MESSAGE EVENT: handle messages when they are received from server
                socket.onmessage = function(message) {
                };

                // CLOSE EVENT
                socket.onclose = (closeEventObject) => {
                    console.log("CLOSE EVENT FIRED. CLOSE OBJECT", closeEventObject);
                    socketStatus.className = "closed";
                    table.innerHTML = "";
                    switch (closeEventObject.code) {
                        case 1006:
                            socketStatus.innerHTML = "Something is wrong with your WS newtork connection";
                            break;
                        case 1001:
                            socketStatus.innerHTML = `Disconnected reason: ${closeEventObject.reason}`;
                            table.innerHTML = "";
                            break; 
                        default:
                            socketStatus.innerHTML = `You disconnected by clicking the Close button.`;
                    }

                    // FORM REMOVAL
                    form.classList.remove("show");
                    message.setAttribute("required", "true");
                    open_ws_btn.disabled = false; 
                    open_ws_btn.style.background = '';
                    open_ws_btn.style.pointerEvents = '';
                    open_ws_btn.textContent = "Open WS";
                };

                // ERROR EVENT
                socket.onerror = (error) => {
                    console.log("Error event was throgn. ERROR OBJECT: ", error);
                    socketStatus.innerHTML = "Error.";
                    socketStatus.className = "closed";
                }

                // *** SEND METHOD
                form.addEventListener('submit', (e) => {
                    e.preventDefault();

                    if(socket.readyState === 1) {
                        let user_text = message.value; 
                        socket.send(user_text);
                        table.innerHTML += '<li class="sent"><span>SENT:</span>' + user_text + '</li>';
                        message.value = "";
                    };
                });

                // *** CLOSE METHOD
                close_ws_btn.addEventListener("click", () => {
                    socketStatus.innerHTML = "closing ... please wait ..."
                    socketStatus.classList.add('closing');
                    socket.close(1000, "I don't like you");
                    message.removeAttribute("required");
                    form.classList.remove("show");
                });
            });
        </script>
    </body>
</html>